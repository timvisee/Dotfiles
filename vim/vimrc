""" Configure vim-plug
set nocompatible
filetype off

" Begin vim-plug plugin loading
call plug#begin('~/.local/share/nvim/plugged')

" General
Plug 'airblade/vim-rooter'
Plug 'jremmen/vim-ripgrep', {'do': 'cargo install ripgrep -f' }
Plug 'tpope/vim-fugitive'
Plug 'tpope/vim-rhubarb'
Plug 'tpope/vim-db'
Plug 'ctrlpvim/ctrlp.vim'
Plug 'tacahiroy/ctrlp-funky'
Plug 'scrooloose/nerdtree'
Plug 'lervag/vimtex'
Plug 'vim-syntastic/syntastic'
Plug 'nvie/vim-flake8'
Plug 'tpope/vim-commentary'
Plug 'airblade/vim-gitgutter'
Plug 'machakann/vim-sandwich'
Plug 'tpope/vim-repeat'
Plug 'hrj/vim-DrawIt'
Plug 'yangmillstheory/vim-snipe'
Plug 'Xuyuanp/nerdtree-git-plugin'
Plug 'reedes/vim-pencil'
Plug 'haya14busa/incsearch.vim'
Plug 'FooSoft/vim-argwrap'
Plug 'junegunn/fzf', { 'dir': '~/.fzf', 'do': './install --all' }
Plug 'junegunn/fzf.vim'

" Editor layout
Plug 'vim-airline/vim-airline'
Plug 'vim-airline/vim-airline-themes'
Plug 'drmingdrmer/vim-tabbar'

" Visualizers
Plug 'junegunn/goyo.vim'
Plug 'junegunn/limelight.vim'
Plug 'RRethy/vim-illuminate'

" Appearance
Plug 'chriskempson/base16-vim'

" Languages
Plug 'rust-lang/rust.vim'
Plug 'beloglazov/vim-online-thesaurus'
Plug 'OrangeT/vim-csharp'

" File types
Plug 'chase/vim-ansible-yaml'
Plug 'dag/vim-fish'
Plug 'ekalinin/Dockerfile.vim'
Plug 'plasticboy/vim-markdown'
Plug 'cespare/vim-toml'
Plug 'posva/vim-vue'
Plug 'StanAngeloff/php.vim'
Plug 'jwalton512/vim-blade'
Plug 'tpope/vim-git'

Plug 'beanworks/vim-phpfmt'
let g:phpfmt_standard = 'PSR2'

" Completion
if has('nvim')
    Plug 'roxma/nvim-completion-manager'
    Plug 'othree/csscomplete.vim'
    Plug 'roxma/nvim-cm-tern', {'do': 'npm install'}
    Plug 'racer-rust/vim-racer'
    Plug 'roxma/nvim-cm-racer'
    Plug 'Shougo/neco-vim'
    Plug 'roxma/LanguageServer-php-neovim', {'do': 'composer install && composer run-script parse-stubs'}
    Plug 'roxma/ncm-github'
    Plug 'fgrsnau/ncm-otherbuf'
    Plug 'SirVer/ultisnips'
    Plug 'honza/vim-snippets'
endif

" End vim-plug plugin loading
call plug#end()



""" General
" We're using Vim, not Vi
set nocompatible

" We've a fast terminal
set ttyfast

" Use lazy redrawing to improve macOS performance
set lazyredraw

" We're using UTF-8 as file/script encoding
scriptencoding utf-8
set encoding=utf-8

" Detect file types and specific indents/settings
filetype on
filetype indent on
filetype plugin on

" Enable use of other .vimrc files in working directories
set exrc

" Use bash as shell (solve compatibility issues)
set shell=/bin/bash

" Set maximum map and key delays
set timeoutlen=500
set ttimeoutlen=0



""" Appearance
" Syntax highlighting
syntax enable

" Enable 256-color mode for terminals
if !has('gui_running')
    set t_Co=256
endif

" Colors
if (match($TERM, "-256color") != -1) && (match($TERM, "screen-256color") == -1)
  set termguicolors
endif
set background=dark
let base16colorspace=256
colorscheme base16-atelier-dune
hi Normal ctermbg=NONE

" Airline theme
let g:airline_theme='base16'

" Airline Pencil status
if exists("PencilMode")
    let g:airline_section_x='%{PencilMode()}'
    "let g:pencil#mode_indicators={'hard': 'H', 'auto': 'A', 'soft': 'S', 'off': '',}
endif

" Relative line numbers
set relativenumber
set number

" Line number on the bar
set ruler

" Highlight the cursor line, set the column color
set cursorline
highlight CursorColumn ctermbg=237 guibg=#3e3e40

" Display tabs and trailing spaces visually
set list listchars=tab:\ \ ,trail:Â·

" Color rows that have lines longer than 81 columns, lines shouldn't be that
" long
"highlight ColorColumn ctermbg=magenta
"call matchadd('ColorColumn', '\v%81v', 100)
set colorcolumn=+1
highlight ColorColumn ctermbg=234 guibg=#1C1C1C

" Highlight TODO
augroup HiglightTodo
    autocmd!
    autocmd WinEnter,VimEnter * :silent! call matchadd('Todo', 'TODO', -1)
    autocmd WinEnter,VimEnter * :silent! call matchadd('Todo', '@todo', -1)
augroup END

" Highlight matching brackets
set showmatch

" No text wrapping
set nowrap

" Disable code folding in Markdown
let g:vim_markdown_folding_disabled=1

" Show 8 rows, 16 columns around the cursor when scrolling, scroll by 1 column
set scrolloff=8
set sidescrolloff=16
set sidescroll=1

" Show commans being typed
set showcmd

" Two lines for the command line
set cmdheight=2

" Always show the status line
set laststatus=2

" Red underline for spelling errors
hi clear SpellBad
hi SpellBad cterm=underline ctermfg=009 guifg=#ff0000

" Matching bracket color
hi MatchParen cterm=bold ctermbg=none ctermfg=magenta

" Define the default Goyo size
let g:goyo_width=82



""" Editing
" Make backspace behaviour consistent, like other programs
set backspace=indent,eol,start

" Smart indents
set autoindent smartindent
set smarttab

" Integrate with system clipboard (not on macOS due to problems)
if !has('unix') && !has('mac')
    set clipboard=unnamedplus,unnamed
endif



""" Code style
" Tab formatting with 4 spaces
set autoindent
set tabstop=4
set softtabstop=4
set expandtab
set fileformat=unix

" Shift 4 columns (rounded to nearest multiple)
set shiftwidth=4
set shiftround

" Lines should not be longer than 80 characters
set textwidth=80
let g:pencil#textwidth=79

" File specific configurations
autocmd FileType ansible,json,markdown,yaml setlocal shiftwidth=2 tabstop=2 softtabstop=2
autocmd FileType go setlocal shiftwidth=8 tabstop=8 softtabstop=8

" File specific commenting styles
autocmd FileType php setlocal comments=sO:*\ -,mO:*\ \ ,exO:*/,s1:/*,mb:*,ex:*/,://
autocmd FileType php,rust setlocal commentstring=//\ %s

" Arg wrap styles
autocmd FileType * unlet! argwrap_tail_comma
autocmd FileType javascript,rust let argwrap_tail_comma=1

" JavaScript highlighting workaround for Vue files
autocmd FileType vue syntax sync fromstart

" Configure pencil mode
augroup pencil
    autocmd!
    autocmd FileType markdown,text call pencil#init({'wrap': 'hard', 'autoformat': 0})
augroup END

" Trailing spaces warnings from airline
autocmd FileType * unlet! g:airline#extensions#whitespace#checks
autocmd FileType markdown let g:airline#extensions#whitespace#checks=['indent']

" Proper CSS completion
autocmd FileType css setlocal omnifunc=csscomplete#CompleteCSS noci



""" Language
" English and Dutch spelling
set spelllang=en,nl

" Disable spell checking
set nospell

" Enable spell checking for some files
autocmd FileType markdown,txt,tex,bib setlocal spell



""" Other utilities and behaviour
" Ignore case sensitivity, unless there's a capital character
set ignorecase
set smartcase

" Wrap searching around
set wrapscan

" Highlight while searching, not after
set nohlsearch
set incsearch

" Store lots of history
set history=1000

" Find recursively in directories
set path+=**

" Show a bigger 'wildmenu' for things like tab completion
set wildmenu

" Split directions
set splitbelow
set splitright

" Always split fugitive diffs vertical
set diffopt+=vertical



""" Custom keybindings
" Enable the mouse
set mouse=a

" Map space and \ as leader keys
let mapleader=" "
let maplocalleader="\\"

" Use <space><space> to toggle to the last buffer
nnoremap <leader><leader> <c-^>

" Use enter to complete
imap <expr> <CR>  (pumvisible() ?  "\<c-y>\<Plug>(expand_or_nl)" : "\<CR>")
imap <expr> <Plug>(expand_or_nl) (cm#completed_is_snippet() ? "\<C-U>":"\<CR>")

" Use tab to complete
inoremap <expr> <Tab> pumvisible() ? "\<C-n>" : "\<Tab>"
inoremap <expr> <S-Tab> pumvisible() ? "\<C-p>" : "\<S-Tab>"

" Incsearch
map /  <Plug>(incsearch-forward)
map ?  <Plug>(incsearch-backward)
map g/ <Plug>(incsearch-stay)

" Arg wrap
nnoremap <silent> <leader>a :ArgWrap<CR>

" Easy commenting
map // :Commentary<CR>

" Ultisnips bindings
let g:UltiSnipsExpandTrigger="<tab>"
let g:UltiSnipsJumpForwardTrigger="<c-b>"
let g:UltiSnipsJumpBackwardTrigger="<c-z>"
let g:UltiSnipsEditSplit="vertical"

" Funky ctrlp: function search
nnoremap <leader>fu :CtrlPFunky<Cr>
" Funky ctrlp: function search word under cursor
nnoremap <leader>fU :execute 'CtrlPFunky ' . expand('<cword>')<Cr>

" Save
inoremap <C-s> <esc>:w<cr>
nnoremap <C-s> :w<cr>

" Auto expanding
inoremap (; (<CR>);<C-c>O
inoremap (, (<CR>),<C-c>O
inoremap {; {<CR>};<C-c>O
inoremap {, {<CR>},<C-c>O
inoremap [; [<CR>];<C-c>O
inoremap [, [<CR>],<C-c>O

" Split navigation
nnoremap <C-J> <C-W><C-J>
nnoremap <C-K> <C-W><C-K>
nnoremap <C-L> <C-W><C-L>
nnoremap <C-H> <C-W><C-H>

" Formatting paragraph with Q
vmap Q gq
nmap Q gqap

" " Vim snipe
map <leader>F <Plug>(snipe-F)
map <leader>f <Plug>(snipe-f)
map <leader>T <Plug>(snipe-T)

map <leader>w <Plug>(snipe-w)
map <leader>W <Plug>(snipe-W)
map <leader>e <Plug>(snipe-e)
map <leader>E <Plug>(snipe-E)
map <leader>b <Plug>(snipe-b)
map <leader>B <Plug>(snipe-B)
map <leader>ge <Plug>(snipe-ge)
map <leader>gE <Plug>(snipe-gE)

" Goyo toggle
nmap <silent> <leader>v :Goyo<CR>
xmap <silent> <leader>v :Goyo<CR>

" Limelight toggle
nmap <silent> <leader>l :Limelight!!<CR>
xmap <silent> <leader>l :Limelight!!<CR>

" Cursor column toggle
nmap <silent> <leader>c :set cursorcolumn!<CR>
xmap <silent> <leader>c :set cursorcolumn!<CR>

" NERDTree toggle
map <silent> <C-n> :NERDTreeToggle<CR>

" Common typos
cnoreabbrev W w
cnoreabbrev Wq wq
cnoreabbrev WQ wq

" Fugitive shortcuts
cnoreabbrev Gc Gcommit
cnoreabbrev Gp Gpush
cnoreabbrev Gs Gstatus

" Disable command line mode binding
nnoremap q: :q



""" Plugins
" Abolish plugin
runtime plugin/abolish.vim

" Dragvisuals plugin
runtime plugin/dragvisuals.vim
vmap <expr> <LEFT>  DVB_Drag('left')
vmap <expr> <RIGHT> DVB_Drag('right')
vmap <expr> <DOWN>  DVB_Drag('down')
vmap <expr> <UP>    DVB_Drag('up')
vmap <expr> D       DVB_Duplicate()

" NERDtree
" Open NERDtree when run with no arguments
autocmd StdinReadPre * let s:std_in=1
autocmd VimEnter * if argc() == 0 && !exists("s:std_in") | NERDTree | endif

" Properly close NERDTree
autocmd bufenter * if (winnr("$") == 1
    \ && exists("b:NERDTree")
    \ && b:NERDTree.isTabTree()) | q | endif

" Show hidden files by default, but hide Vim swap files
let NERDTreeShowHidden=1
let NERDTreeIgnore = ['\..*\.sw[pom]$']

" Define the tool and browser for markdown preview
let vim_markdown_preview_github=1
let vim_markdown_preview_browser='FirefoxNightly'

" Syntastic options
let g:syntastic_always_populate_loc_list=1
let g:syntastic_auto_loc_list=1
let g:syntastic_enable_signs=1
let g:syntastic_check_on_wq=0
let g:syntastic_aggregate_errors=1
let g:syntastic_loc_list_height=5
let g:syntastic_error_symbol='X'
let g:syntastic_style_error_symbol='X'
let g:syntastic_warning_symbol='x'
let g:syntastic_style_warning_symbol='x'

" YouCompleteMe
let g:ycm_autoclose_preview_window_after_completion=1

" Toggle Limelight with Goyo
function! s:goyo_enter()
    " Enable Limelight
    Limelight
endfunction

function! s:goyo_leave()
    " Disable Limelight
    Limelight!
endfunction

autocmd! User GoyoEnter nested call <SID>goyo_enter()
autocmd! User GoyoLeave nested call <SID>goyo_leave()

" vimtex
" Set the vimtex PDF viewer to use
let g:vimtex_view_method="zathura"

" Use fd in ctrlp if installed for fast searches
if executable('fd')
    let g:ctrlp_user_command='fd -c never --hidden --follow --exclude .git "" %s'
    let g:ctrlp_use_caching=0
endif

" Patch comment background colors for some systems
hi Comment cterm=bold
